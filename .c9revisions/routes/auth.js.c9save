{"ts":1356084499298,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var config = require('../configs/config.js');\nvar locale = require('../configs/locale/main.js');\nvar ext_achivster = require('../external/achivster.js');\n\nvar geoip = require('geoip-lite');\nvar randomstring = require('randomstring');\nvar db;\n\nfunction mongoConnect() {\n  var mongodb = require(\"mongodb\"),\n    mongoserver = new mongodb.Server(config.mongo.host, config.mongo.port, config.mongo.server_config),\n    db_connector = new mongodb.Db(config.mongo.db, mongoserver, config.mongo.connector_config);\n\n  db_connector.open(function(err, dbs) {\n    db = dbs;\n  });\n}\n\nmongoConnect();\n\nexports.login = function(req, res) {\n  console.log(req.session);\n  var region = '';\n  //var region = geoip.lookup(req.connection.remoteAddress).country;\n  db.collection('users', function(err,collection) {\n    if(req.session.auth && req.session.auth === true) {\n      res.redirect(config.site.url);\n    }\n\n    if(req.body.action === 'login') {\n      collection.findOne({email: req.body.email}, function(err, doc) {\n        if(doc !== null) {\n          if(req.body.pass === doc.password) {\n            add_session(req, doc.uid, doc.email, region, function() {\n              res.end(JSON.stringify({}));\n            });\n          } else {\n            res.end(JSON.stringify({error: locale.errors.err1.eng}));\n          }\n        } else {\n          res.end(JSON.stringify({error: locale.errors.err1.eng}));\n        }\n      });\n    } else if(req.body.action === 'reg') {\n      testUser(req.body.email, function(flag) {\n        if(flag === true) {\n          registerUser(req.body.email, req.body.pass, region, req, function(){\n            res.end(JSON.stringify({}));\n          });\n        } else {\n          res.end(JSON.stringify({error: locale.errors.err2.eng}));\n        } \n      });\n    } else {\n      res.render('login.ect', { title: 'Login' });\n    }\n  });\n};\n\nfunction testUser(email, cb) {\n  db.collection('users', function(err,collection) {\n    collection.findOne({email: email}, function(err, doc) {\n      if(doc !== null) { \n        cb(false);\n      } else {\n        cb(true);\n      }\n    });\n  });  \n}\n\nfunction registerUser(email, pass, region, req, cb) {\n  var uid = randomstring.generate(20);\n  db.collection('users', function(err,collection) {\n    collection.insert({email: email, password: pass, uid: uid}, function(err, doc) {\n      db.collection('users_profile', function(err,profiles) {\n        profiles.insert({uid: uid, name: '', photo: '/images/label.png', friends: []}, function(err, doc) {\n          db.collection('services_connections', function(err, services_connections) {\n            services_connections.insert({uid: uid, service: 'achivster', service_login: '', addtime: new Date().getTime(), valid: true, lastupdate: new Date().getTime() - 1800000}, function(err, doc) {\n              db.collection('users_achievements', function(err, users_achievements) {  \n                users_achievements.insert({uid: uid, service: 'achivster', achievements: []}, function(err, doc) {});\n                ext_achivster.main(uid, 'klxNE51gc8k3jGZYd2i0wAZAPMDviG');\n                add_session(req, uid, email, region, function() {\n                  cb();\n                });\n              });\n            });\n          });\n        });\n      });\n    });\n  });\n}\n\nfunction add_session(req, uid, email, lang, cb) {\n  req.session.auth = true;\n  req.session.uid = uid;\n  req.session.email = email;\n  req.session.lang = lang;\n  cb();\n}\n\nexports.logout = function(req, res) {\n  req.session.auth = false;\n  res.redirect(config.site.url);\n};\n"]],"start1":0,"start2":0,"length1":0,"length2":3534}]],"length":3534}
{"contributors":[],"silentsave":false,"ts":1356273186546,"patch":[[{"diffs":[[0,") {\n"],[-1,"  console.log(req.session);\n"],[0,"  va"]],"start1":620,"start2":620,"length1":36,"length2":8}]],"length":3506,"saved":false}
{"ts":1356273339963,"patch":[[{"diffs":[[0,"omstring');\n"],[1,"var nodemailer = require(\"nodemailer\");\n\n"],[0,"var db;\n\nfun"]],"start1":222,"start2":222,"length1":24,"length2":65},{"diffs":[[0,"\n  });  \n}\n\n"],[1,"function send_mail_confirmation(uid) {\n  var smtpTransport = nodemailer.createTransport(\"SMTP\",{\n    service: \"Yandex\",\n    auth: {\n        user: \"support@achivster.com\",\n        pass: \"AO4dtGvORf\"\n    }\n  });\n\n  var mailOptions = {\n    from: \"Achivster Support <support@achivster.com>\",\n    to: \"baboonweb@gmail.com\",\n    subject: \"Hello\",\n    text: \"Hello world\", \n    html: \"<b>Hello world</b>\" \n  };\n\n  smtpTransport.sendMail(mailOptions, function(error, response){\n    if(error){\n        console.log(error);\n    }else{\n        console.log(\"Message sent: \" + response.message);\n    }\n\n    smtpTransport.close();\n  });\n}\n\n"],[0,"function reg"]],"start1":2098,"start2":2098,"length1":24,"length2":649}]],"length":4172,"saved":false}
{"ts":1356273395690,"patch":[[{"diffs":[[0,"tion(uid"],[1,", email"],[0,") {\n  va"]],"start1":2137,"start2":2137,"length1":16,"length2":23},{"diffs":[[0,"to: "],[-1,"\"baboonweb@gmail.com\""],[1,"email"],[0,",\n  "]],"start1":2409,"start2":2409,"length1":29,"length2":13},{"diffs":[[0,"DviG');\n"],[1,"                send_mail_confirmation(uid, email);\n"],[0,"        "]],"start1":3687,"start2":3687,"length1":16,"length2":68}]],"length":4215,"saved":false}
{"ts":1356273461968,"patch":[[{"diffs":[[0,"te(20);\n"],[1,"  var access_key = randomstring.generate(40);\n"],[0,"  db.col"]],"start1":2811,"start2":2811,"length1":16,"length2":62},{"diffs":[[0,"d, email"],[1,", access_key"],[0,");\n     "]],"start1":3782,"start2":3782,"length1":16,"length2":28}]],"length":4273,"saved":false}
{"ts":1356273506136,"patch":[[{"diffs":[[0,"uid: uid"],[1,", access_key: access_key"],[0,"}, funct"]],"start1":2970,"start2":2970,"length1":16,"length2":40}]],"length":4297,"saved":false}
{"ts":1356273760700,"patch":[[{"diffs":[[0,"d, email"],[1,", access_key"],[0,") {\n  va"]],"start1":2144,"start2":2144,"length1":16,"length2":28},{"diffs":[[0,"lo\","],[1," "],[0,"\n    "],[-1,"text: \"Hello world\", \n    html: \"<b>Hello world</b>\" "],[1,"html: '<a href=\"http://achivster.com/login/access_key?='+access_key+'\">Подтвердить</a>'"],[0,"\n  }"]],"start1":2449,"start2":2449,"length1":66,"length2":101}]],"length":4344,"saved":false}
{"ts":1356274039085,"patch":[[{"diffs":[[0,"b();\n}\n\n"],[1,"exports.access_key = function(req, res) {\n  console.log(req.query);\n};\n\n"],[0,"exports."]],"start1":4234,"start2":4234,"length1":16,"length2":88}]],"length":4416,"saved":false}
{"ts":1356274096806,"patch":[[{"diffs":[[0,"\"http://"],[-1,"achivster.com"],[1,"'+config.site.url+'"],[0,"/login/a"]],"start1":2474,"start2":2474,"length1":29,"length2":35}]],"length":4422,"saved":false}
{"ts":1356274110575,"patch":[[{"diffs":[[0,"query);\n"],[1,"  res.end();\n"],[0,"};\n\nexpo"]],"start1":4308,"start2":4308,"length1":16,"length2":29}]],"length":4435,"saved":false}
